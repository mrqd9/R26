<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramzan Nagpur 2026</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg-olive: #929581; --card-bg: #f4f4f1; --accent-yellow: #ffcc00; --text-dark: #333; }
        body { font-family: sans-serif; background-color: var(--bg-olive); color: var(--text-dark); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
        .container { width: 90%; max-width: 400px; background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 4px solid white; }
        .time-box { display: flex; justify-content: space-around; margin: 20px 0; }
        .time-value { font-size: 1.8rem; font-weight: bold; }
        .btn-notify { background: var(--bg-olive); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; }
        #status { margin-top: 15px; font-size: 0.8rem; color: #666; background: #eee; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Ramzan Nagpur 2026</h2>
        <div id="ramzan-day" style="font-size: 3rem; font-weight: 900;">--</div>
        <div class="time-box">
            <div><div>Sahar</div><div id="sahar-time" class="time-value">--:--</div></div>
            <div><div>Iftar</div><div id="iftar-time" class="time-value">--:--</div></div>
        </div>
        <button class="btn-notify" onclick="enableNotifications()">Pin Daily Notification</button>
        <div id="status">System: Ready</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        
        // Register SW with better error catching
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => statusDiv.innerText = "Status: App Registered")
                .catch(err => statusDiv.innerText = "SW Error: " + err);
        }

        async function updateUI() {
            try {
                const response = await fetch('schedule.json');
                const schedule = await response.json();
                const today = new Date().toLocaleDateString('en-CA'); 
                const data = schedule.find(item => item.date === today);

                if (data) {
                    document.getElementById('ramzan-day').innerText = data.day;
                    document.getElementById('sahar-time').innerText = data.sahar;
                    document.getElementById('iftar-time').innerText = data.iftar;
                    return data;
                } else {
                    document.getElementById('ramzan-day').innerText = "Off";
                    statusDiv.innerText = "Status: Not in Ramzan Period";
                }
            } catch (e) { statusDiv.innerText = "Data Error: " + e; }
        }

        async function enableNotifications() {
            statusDiv.innerText = "Requesting permission...";
            
            if (!('Notification' in window)) {
                alert("Notifications not supported in this browser.");
                return;
            }

            const permission = await Notification.requestPermission();
            statusDiv.innerText = "Permission: " + permission;

            if (permission === 'granted') {
                const data = await updateUI();
                if (data) {
                    // Force the Service Worker to show the notification
                    const reg = await navigator.serviceWorker.ready;
                    reg.active.postMessage({ type: 'UPDATE_NOTIFICATION', payload: data });
                }
            } else if (permission === 'denied') {
                alert("Please click the Lock icon in your browser URL bar and Reset Permissions.");
            }
        }

        window.onload = updateUI;
    </script>
</body>
</html>
